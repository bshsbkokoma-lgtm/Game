<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมเลือกอะไรดี (เล่นหลายคน)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter and Noto Sans Thai fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+Thai:wght@400;600;800&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
        }
        .container {
            max-width: 900px;
            width: 100%;
        }
    </style>
</head>
<body class="p-4">

    <div id="app-container" class="container bg-white shadow-2xl rounded-xl p-4 md:p-8 space-y-6">
        <header class="text-center space-y-2 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-indigo-600 md:text-4xl">
                เลือกอะไรดี? (เล่นหลายคน)
            </h1>
            <p id="user-status-display" class="text-lg text-gray-500 font-medium">สถานะ: กำลังโหลด...</p>
        </header>

        <!-- General Message/Error Box -->
        <div id="global-message" class="hidden p-3 rounded-lg font-medium text-center transition-all duration-300"></div>

        <!-- --- VIEW 1: Nickname Input --- -->
        <div id="nickname-view" class="space-y-4">
            <h2 class="text-2xl font-bold text-gray-700">1. เข้าสู่ระบบ</h2>
            <input type="text" id="nickname-input" placeholder="ใส่ชื่อเล่นของคุณ (เช่น: น้องแมว)" maxlength="15" 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg">
            <button id="join-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg transition transform hover:scale-[1.01] active:scale-[0.99] shadow-md">
                เข้าร่วมล็อบบี้
            </button>
        </div>

        <!-- --- VIEW 2: Lobby/Online Users --- -->
        <div id="lobby-view" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-gray-700 border-b pb-2">2. ผู้เล่นออนไลน์</h2>
            <div id="invitation-notification" class="hidden p-4 rounded-xl shadow-lg bg-yellow-100 border border-yellow-400 space-y-3">
                <p id="invitation-text" class="font-bold text-yellow-800 text-center text-lg">
                    [Player] เชิญคุณเล่นเกม!
                </p>
                <div class="flex space-x-3">
                    <button id="accept-invite-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition">
                        ตอบรับ
                    </button>
                    <button id="decline-invite-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition">
                        ปฏิเสธ
                    </button>
                </div>
            </div>

            <ul id="online-users-list" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                <li class="text-center text-gray-500">
                    กำลังค้นหาผู้เล่น...
                </li>
            </ul>
        </div>

        <!-- --- VIEW 3: In-Game Session --- -->
        <div id="game-view" class="hidden space-y-8">
            <div class="text-center space-y-2">
                <p class="text-xl text-gray-500">คุณกำลังเล่นกับ:</p>
                <p id="opponent-name" class="text-3xl font-extrabold text-pink-600">...</p>
                <p id="question-number" class="text-xl font-semibold text-gray-700 pt-2"></p>
                
                <!-- Choice Container -->
                <div class="bg-indigo-50 p-4 rounded-xl shadow-inner mt-4">
                    <p class="text-2xl font-bold text-indigo-800">คำถาม: <span id="current-question-text" class="text-3xl">?</span></p>
                </div>
            </div>

            <!-- Choice Buttons -->
            <div id="choice-buttons-container" class="grid grid-cols-1 gap-4 md:grid-cols-2">
                <button id="game-choice-a" data-choice="0" class="game-choice-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-extrabold py-5 px-4 rounded-xl text-2xl shadow-lg transition transform hover:scale-[1.02] active:scale-[0.98]">
                    Choice A
                </button>
                <div class="text-center text-3xl font-black text-gray-400 py-2 hidden md:block">
                    หรือ
                </div>
                <button id="game-choice-b" data-choice="1" class="game-choice-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-extrabold py-5 px-4 rounded-xl text-2xl shadow-lg transition transform hover:scale-[1.02] active:scale-[0.98]">
                    Choice B
                </button>
            </div>
            
            <!-- Player Status Indicators -->
            <div id="player-status-indicators" class="grid grid-cols-2 gap-4 text-center">
                <div class="p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm font-semibold text-gray-600">คุณ</p>
                    <div id="my-choice-status" class="text-xl font-bold text-yellow-600">...</div>
                </div>
                <div class="p-3 bg-gray-100 rounded-lg">
                    <p class="text-sm font-semibold text-gray-600">คู่ต่อสู้</p>
                    <div id="opponent-choice-status" class="text-xl font-bold text-gray-400">รอ...</div>
                </div>
            </div>

            <!-- Reveal / Next Question Button -->
            <button id="next-round-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg text-lg transition hidden">
                คำถามต่อไป
            </button>
        </div>
        
        <!-- Game Over Modal (Hidden by default) -->
        <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center space-y-4 shadow-2xl">
                <h3 class="text-3xl font-bold text-green-600">เกมจบแล้ว!</h3>
                <p id="final-score-message" class="text-xl text-gray-700"></p>
                <button id="back-to-lobby-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg text-lg transition duration-200">
                    กลับสู่ล็อบบี้
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Game Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ส่วนที่ 1: การตั้งค่า Firebase (นำค่าที่คุณให้มาใส่เรียบร้อยแล้ว) ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA4VP_-06lqomseyhewH6Iv6eOMPwG8nnU",
            authDomain: "game-8ede6.firebaseapp.com",
            projectId: "game-8ede6",
            storageBucket: "game-8ede6.firebasestorage.app",
            messagingSenderId: "206374174939",
            appId: "1:206374174939:web:48556411426f53859a4cfe",
            measurementId: "G-KG84KJ11VC" // ไม่ได้ใช้งานแต่ใส่ไว้เพื่อความสมบูรณ์
        };
        
        // ใช้ ID นี้สำหรับ Isolation Path ใน Firestore เพื่อไม่ให้ข้อมูลปนกับแอปอื่น
        const APP_IDENTIFIER = 'multiplayer-this-or-that-public';

        // --- Firebase Globals ---
        let db = null;
        let auth = null;
        let userId = null;
        let nickname = '';

        // --- Game State Globals ---
        let isAuthReady = false;
        let currentGameId = null;
        let isHost = false;
        let unsubscribeLobby = null; 
        let unsubscribeGame = null;  
        let questionPairs = []; 
        let totalQuestions = 0;

        // Set Firestore debug log level
        if (typeof setLogLevel === 'function') {
            setLogLevel('debug');
        }

        // --- Data: List of Thai "This or That" Choices ---
        const ALL_CHOICE_PAIRS = [
            ["แมว", "หมา"], ["กาแฟ", "ชา"], ["ทะเล", "ภูเขา"], ["ดูหนัง", "อ่านหนังสือ"],
            ["ฤดูร้อน", "ฤดูหนาว"], ["เดินทางคนเดียว", "เดินทางกับเพื่อน"], ["โทรศัพท์", "คอมพิวเตอร์"],
            ["อาหารคาว", "อาหารหวาน"], ["เพลงเร็ว", "เพลงช้า"], ["ตื่นเช้า", "นอนดึก"],
            ["เงิน", "ชื่อเสียง"], ["อดีต", "อนาคต"], ["ชีวิตในเมือง", "ชีวิตในชนบท"],
            ["การ์ตูน", "สารคดี"], ["ฝนตก", "แดดออก"], ["สุนัขตัวเล็ก", "สุนัขตัวใหญ่"],
            ["กินเผ็ด", "กินหวาน"], ["รถยนต์", "มอเตอร์ไซค์"], ["กลางวัน", "กลางคืน"],
            ["หนังตลก", "หนังแอคชั่น"]
        ];

        // --- DOM Elements (ไม่ได้เปลี่ยนแปลง) ---
        const userStatusDisplayEl = document.getElementById('user-status-display');
        const globalMessageEl = document.getElementById('global-message');
        const nicknameViewEl = document.getElementById('nickname-view');
        const nicknameInputEl = document.getElementById('nickname-input');
        const joinBtn = document.getElementById('join-btn');
        const lobbyViewEl = document.getElementById('lobby-view');
        const onlineUsersListEl = document.getElementById('online-users-list');
        const gameViewEl = document.getElementById('game-view');
        const opponentNameEl = document.getElementById('opponent-name');
        const questionNumberEl = document.getElementById('question-number');
        const currentQuestionTextEl = document.getElementById('current-question-text');
        const choiceABtn = document.getElementById('game-choice-a');
        const choiceBBtn = document.getElementById('game-choice-b');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const myChoiceStatusEl = document.getElementById('my-choice-status');
        const opponentChoiceStatusEl = document.getElementById('opponent-choice-status');
        const invitationNotificationEl = document.getElementById('invitation-notification');
        const invitationTextEl = document.getElementById('invitation-text');
        const acceptInviteBtn = document.getElementById('accept-invite-btn');
        const declineInviteBtn = document.getElementById('decline-invite-btn');
        const gameOverModalEl = document.getElementById('game-over-modal');
        const finalScoreMessageEl = document.getElementById('final-score-message');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn');

        // --- Utility Functions (ไม่ได้เปลี่ยนแปลง) ---

        function showGlobalMessage(msg, type = 'info') {
            globalMessageEl.textContent = msg;
            globalMessageEl.className = 'p-3 rounded-lg font-medium text-center transition-all duration-300';
            
            if (type === 'success') {
                globalMessageEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
            } else if (type === 'error') {
                globalMessageEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            } else if (type === 'warning') {
                globalMessageEl.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
            } else { // info/default
                globalMessageEl.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
            }
            globalMessageEl.classList.remove('hidden');
            
            // Auto hide after a few seconds
            setTimeout(() => {
                globalMessageEl.classList.add('hidden');
            }, 5000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function setView(viewName) {
            nicknameViewEl.classList.add('hidden');
            lobbyViewEl.classList.add('hidden');
            gameViewEl.classList.add('hidden');
            gameOverModalEl.classList.add('hidden');
            invitationNotificationEl.classList.add('hidden');
            
            switch (viewName) {
                case 'nickname':
                    nicknameViewEl.classList.remove('hidden');
                    userStatusDisplayEl.textContent = 'สถานะ: ต้องระบุชื่อเล่น';
                    break;
                case 'lobby':
                    lobbyViewEl.classList.remove('hidden');
                    userStatusDisplayEl.textContent = `สถานะ: ล็อบบี้ (ชื่อ ${nickname})`;
                    break;
                case 'game':
                    gameViewEl.classList.remove('hidden');
                    userStatusDisplayEl.textContent = `สถานะ: กำลังเล่นเกม (กับ ${opponentNameEl.textContent})`;
                    break;
                case 'game-over':
                    gameOverModalEl.classList.remove('hidden');
                    break;
            }
        }

        // --- Firestore Reference Functions ---

        function getPublicDocRef(collectionName, docId) {
            return doc(db, 
                'artifacts', APP_IDENTIFIER, 
                'public', 'data', 
                collectionName, 
                docId
            );
        }

        function getPublicCollectionRef(collectionName) {
            return collection(db, 
                'artifacts', APP_IDENTIFIER, 
                'public', 'data', 
                collectionName
            );
        }

        // --- Core Game Logic ---

        function updatePlayerStatus(newStatus) {
            if (!userId) return;

            const userDocRef = getPublicDocRef('onlineUsers', userId);
            setDoc(userDocRef, {
                nickname: nickname,
                status: newStatus, 
                lastActive: serverTimestamp()
            }, { merge: true }).catch(e => console.error("Error updating user status:", e));
        }

        async function createGame(opponentId, opponentNickname) {
            try {
                // 1. Prepare questions
                let shuffledQuestions = [...ALL_CHOICE_PAIRS];
                shuffleArray(shuffledQuestions);
                questionPairs = shuffledQuestions.slice(0, 10);
                totalQuestions = questionPairs.length;
                
                // 2. Create the game document
                const gameDocRef = doc(getPublicCollectionRef('games'));
                currentGameId = gameDocRef.id;
                isHost = true;

                const gameData = {
                    status: 'WAITING_FOR_INVITE',
                    hostId: userId,
                    opponentId: opponentId,
                    players: {
                        [userId]: { nickname: nickname, choice: null, ready: false },
                        [opponentId]: { nickname: opponentNickname, choice: null, ready: false }
                    },
                    currentQuestionIndex: 0,
                    questions: questionPairs,
                    createdAt: serverTimestamp(),
                    lastActionTime: serverTimestamp()
                };

                await setDoc(gameDocRef, gameData);
                showGlobalMessage(`เชิญ ${opponentNickname} แล้ว! กำลังรอการตอบรับ...`, 'warning');
                
                // 3. Update status and start listening to the game
                updatePlayerStatus('WaitingForResponse');
                startListeningToGame(currentGameId);

            } catch (error) {
                console.error("Error creating game:", error);
                showGlobalMessage('ไม่สามารถสร้างเกมได้: โปรดลองอีกครั้ง', 'error');
            }
        }
        
        async function acceptInvitation(gameId) {
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDocRef = getPublicDocRef('games', gameId);
                    const gameDoc = await transaction.get(gameDocRef);

                    if (!gameDoc.exists()) {
                        throw "Game does not exist anymore!";
                    }

                    const gameData = gameDoc.data();
                    
                    if (gameData.status === 'WAITING_FOR_INVITE') {
                         // Set game status to active and initialize first round
                        transaction.update(gameDocRef, {
                            status: 'PENDING_CHOICE',
                            lastActionTime: serverTimestamp()
                        });
                        
                        // Set current game ID and host status
                        currentGameId = gameId;
                        isHost = false; 
                        
                        // Copy necessary initial data from the accepted game document
                        questionPairs = gameData.questions || [];
                        totalQuestions = questionPairs.length;
                        
                        // Update status and start listening
                        updatePlayerStatus('InGame');
                        startListeningToGame(gameId);
                        
                        showGlobalMessage('ตอบรับคำเชิญแล้ว! เกมกำลังจะเริ่ม...', 'success');
                    } else {
                         throw "Invitation already accepted or cancelled.";
                    }
                });
            } catch (error) {
                console.error("Transaction failed (Accept Invite):", error);
                showGlobalMessage('ไม่สามารถตอบรับคำเชิญได้: ' + (typeof error === 'string' ? error : ''), 'error');
                updatePlayerStatus('Online'); 
            }
        }
        
        async function declineInvitation(gameId) {
            try {
                await updateDoc(getPublicDocRef('games', gameId), {
                    status: 'DECLINED',
                    lastActionTime: serverTimestamp()
                });
                showGlobalMessage('ปฏิเสธคำเชิญแล้ว', 'info');
                updatePlayerStatus('Online');
                invitationNotificationEl.classList.add('hidden');
            } catch (e) {
                 console.error("Error declining invite:", e);
            }
        }
        
        async function leaveGame() {
            if (!currentGameId) return;

            if (unsubscribeGame) unsubscribeGame();
            unsubscribeGame = null;
            
            try {
                const gameDocRef = getPublicDocRef('games', currentGameId);

                if (isHost) {
                    await deleteDoc(gameDocRef);
                    showGlobalMessage('คุณได้ออกจากเกมแล้ว (เกมเซสชั่นถูกลบ)', 'warning');
                } else {
                    await updateDoc(gameDocRef, {
                        status: 'OPPONENT_LEFT',
                        lastActionTime: serverTimestamp()
                    });
                    showGlobalMessage('คุณได้ออกจากเกมแล้ว', 'warning');
                }

            } catch (error) {
                console.error("Error leaving game:", error);
                showGlobalMessage('ออกจากเกมไม่สำเร็จ', 'error');
            } finally {
                currentGameId = null;
                isHost = false;
                questionPairs = [];
                totalQuestions = 0;
                updatePlayerStatus('Online');
                setView('lobby');
            }
        }


        // --- REAL-TIME LISTENERS ---

        function startListeningToLobby() {
            if (unsubscribeLobby) unsubscribeLobby();

            const q = query(
                getPublicCollectionRef('onlineUsers'),
                where('status', 'in', ['Online', 'WaitingForResponse'])
            );

            unsubscribeLobby = onSnapshot(q, (snapshot) => {
                let html = '';
                let hasAvailableUser = false;
                onlineUsersListEl.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const otherUserId = doc.id;

                    if (otherUserId === userId) {
                        return; 
                    }

                    hasAvailableUser = true;
                    
                    let buttonHtml;
                    let statusText;
                    let buttonClass;

                    if (userData.status === 'Online') {
                        statusText = 'พร้อมเล่น';
                        buttonClass = 'bg-indigo-500 hover:bg-indigo-600';
                        buttonHtml = `<button data-id="${otherUserId}" data-name="${userData.nickname}" class="invite-btn px-3 py-1 text-sm font-semibold rounded-lg text-white ${buttonClass}">เชิญเล่น</button>`;
                    } else if (userData.status === 'WaitingForResponse') {
                        statusText = 'รอตอบรับ';
                        buttonClass = 'bg-gray-400 cursor-not-allowed';
                        buttonHtml = `<button disabled class="px-3 py-1 text-sm font-semibold rounded-lg text-white ${buttonClass}">รอ...</button>`;
                    }
                    
                    html += `
                        <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-100">
                            <div class="space-y-0.5">
                                <p class="text-lg font-bold text-gray-800">${userData.nickname}</p>
                                <p class="text-sm text-gray-500">${statusText}</p>
                            </div>
                            ${buttonHtml}
                        </li>
                    `;
                });

                if (!hasAvailableUser) {
                     html = '<li class="text-center text-gray-500 p-4">ไม่มีผู้เล่นที่พร้อมเล่นอื่นในขณะนี้.</li>';
                }

                onlineUsersListEl.innerHTML = html;
            });
        }
        
        function startListeningToGame(gameId) {
            if (unsubscribeGame) unsubscribeGame();
            setView('game');

            const gameDocRef = getPublicDocRef('games', gameId);

            unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    handleGameEnd(true);
                    return;
                }
                
                const gameData = docSnap.data();

                if (gameData.status === 'WAITING_FOR_INVITE' && gameData.opponentId === userId) {
                    currentGameId = gameId; 
                    invitationTextEl.textContent = `${gameData.players[gameData.hostId].nickname} เชิญคุณเล่นเกม!`;
                    invitationNotificationEl.classList.remove('hidden');
                    return;
                }
                
                if (gameData.status === 'DECLINED' && gameData.hostId === userId) {
                    showGlobalMessage(`${gameData.players[gameData.opponentId].nickname} ปฏิเสธคำเชิญของคุณ`, 'warning');
                    leaveGame();
                    return;
                }
                
                if (gameData.status === 'OPPONENT_LEFT') {
                    showGlobalMessage('คู่ต่อสู้ออกจากเกมแล้ว', 'error');
                    handleGameEnd(true);
                    return;
                }

                if (gameData.status === 'GAME_OVER') {
                    handleGameEnd(false, gameData);
                    return;
                }

                if (gameData.status === 'PENDING_CHOICE' || gameData.status === 'REVEAL_RESULTS') {
                    renderGame(gameData);
                }

            }, (error) => {
                console.error("Game listener error:", error);
                showGlobalMessage('การเชื่อมต่อเกมมีปัญหา', 'error');
                handleGameEnd(true);
            });
        }
        
        // --- GAME RENDER & INTERACTION ---

        function renderGame(gameData) {
            if (!gameData || !userId) return;

            const myData = gameData.players[userId];
            const opponentId = gameData.hostId === userId ? gameData.opponentId : gameData.hostId;
            const opponentData = gameData.players[opponentId];
            
            opponentNameEl.textContent = opponentData.nickname;
            
            const currentQIndex = gameData.currentQuestionIndex;
            const currentQ = gameData.questions[currentQIndex];
            
            questionNumberEl.textContent = `คำถามที่ ${currentQIndex + 1} / ${totalQuestions}`;
            currentQuestionTextEl.textContent = currentQ[0] + ' หรือ ' + currentQ[1];
            
            choiceABtn.textContent = currentQ[0];
            choiceBBtn.textContent = currentQ[1];
            
            // --- PENDING CHOICE STATE ---
            if (gameData.status === 'PENDING_CHOICE') {
                nextRoundBtn.classList.add('hidden');
                
                // My Status
                if (myData.choice === null) {
                    myChoiceStatusEl.textContent = 'ยังไม่ได้เลือก';
                    myChoiceStatusEl.classList.replace('text-green-600', 'text-yellow-600');
                    choiceABtn.disabled = false;
                    choiceBBtn.disabled = false;
                } else {
                    myChoiceStatusEl.textContent = 'เลือกแล้ว';
                    myChoiceStatusEl.classList.replace('text-yellow-600', 'text-green-600');
                    choiceABtn.disabled = true;
                    choiceBBtn.disabled = true;
                }
                
                // Opponent Status
                if (opponentData.choice === null) {
                    opponentChoiceStatusEl.textContent = 'รอเลือก...';
                    opponentChoiceStatusEl.classList.replace('text-green-600', 'text-gray-400');
                } else {
                    opponentChoiceStatusEl.textContent = 'เลือกแล้ว';
                    opponentChoiceStatusEl.classList.replace('text-gray-400', 'text-green-600');
                }
            }
            
            // --- REVEAL RESULTS STATE ---
            if (gameData.status === 'REVEAL_RESULTS') {
                choiceABtn.disabled = true;
                choiceBBtn.disabled = true;
                
                // Get chosen texts (0 for A, 1 for B)
                const myChosenText = currentQ[myData.choice];
                const opponentChosenText = currentQ[opponentData.choice];
                
                myChoiceStatusEl.textContent = `เลือก: ${myChosenText}`;
                opponentChoiceStatusEl.textContent = `เลือก: ${opponentChosenText}`;
                
                // Check if both choices are the same
                const isSameChoice = myChosenText === opponentChosenText;

                if (isSameChoice) {
                    myChoiceStatusEl.classList.add('bg-blue-200');
                    opponentChoiceStatusEl.classList.add('bg-blue-200');
                    showGlobalMessage('เลือกเหมือนกัน! (ใจตรงกัน)', 'info');
                } else {
                    myChoiceStatusEl.classList.remove('bg-blue-200');
                    opponentChoiceStatusEl.classList.remove('bg-blue-200');
                    showGlobalMessage('เลือกไม่เหมือนกัน (คนละทาง)', 'warning');
                }
                
                // Only the host sees the "Next Round" button
                if (isHost) {
                    nextRoundBtn.classList.remove('hidden');
                    nextRoundBtn.textContent = (currentQIndex + 1) < totalQuestions ? 'คำถามต่อไป' : 'จบเกม';
                    nextRoundBtn.classList.remove('bg-green-500', 'bg-blue-500');
                    nextRoundBtn.classList.add((currentQIndex + 1) < totalQuestions ? 'bg-blue-500' : 'bg-green-500');
                } else {
                    nextRoundBtn.classList.add('hidden');
                }
            }
        }
        
        async function handleChoiceSelection(choiceIndex) {
            if (!currentGameId) return;

            const gameDocRef = getPublicDocRef('games', currentGameId);

            // ใช้ Transaction เพื่ออัปเดตสถานะการเลือกและตรวจสอบว่าคู่แข่งเลือกครบหรือยัง
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameDocRef);
                    if (!gameDoc.exists()) throw "Game ended unexpectedly.";

                    const gameData = gameDoc.data();
                    const opponentId = getOpponentId(gameData);
                    
                    // บันทึกการเลือกของเรา
                    let updateObject = {
                        [`players.${userId}.choice`]: choiceIndex,
                        lastActionTime: serverTimestamp()
                    };

                    // ตรวจสอบว่าคู่แข่งเลือกแล้วหรือยัง
                    if (gameData.players[opponentId].choice !== null) {
                        // ถ้าคู่แข่งเลือกแล้ว, ให้เปลี่ยนสถานะเป็น REVEAL_RESULTS
                        updateObject.status = 'REVEAL_RESULTS';
                    }

                    transaction.update(gameDocRef, updateObject);
                });
                showGlobalMessage('บันทึกตัวเลือกของคุณแล้ว! รอคู่ต่อสู้อยู่...', 'info');

            } catch (error) {
                console.error("Error setting choice (transaction failed):", error);
                showGlobalMessage('บันทึกตัวเลือกไม่สำเร็จ', 'error');
            }
        }
        
        async function nextRound() {
            if (!currentGameId || !isHost) return;

            const gameDocRef = getPublicDocRef('games', currentGameId);
            // ต้องดึงข้อมูลล่าสุดมาเพื่อดู index
            const docSnap = await doc(db, getPublicDocRef('games', currentGameId).path).get();
            if (!docSnap.exists()) return;
            const currentQIndex = docSnap.data().currentQuestionIndex;

            if (currentQIndex + 1 >= totalQuestions) {
                // End game
                await updateDoc(gameDocRef, {
                    status: 'GAME_OVER',
                    lastActionTime: serverTimestamp()
                });
            } else {
                // Next question
                try {
                    await updateDoc(gameDocRef, {
                        status: 'PENDING_CHOICE',
                        currentQuestionIndex: currentQIndex + 1,
                        [`players.${userId}.choice`]: null,
                        [`players.${getOpponentId(docSnap.data())}.choice`]: null,
                        lastActionTime: serverTimestamp()
                    });
                    nextRoundBtn.classList.add('hidden');
                } catch (error) {
                    console.error("Error advancing round:", error);
                    showGlobalMessage('ไม่สามารถไปคำถามต่อไปได้', 'error');
                }
            }
        }
        
        function getOpponentId(gameData) {
            return gameData.hostId === userId ? gameData.opponentId : gameData.hostId;
        }

        function handleGameEnd(wasInterrupted, gameData = null) {
            if (unsubscribeGame) unsubscribeGame();
            unsubscribeGame = null;
            currentGameId = null;

            if (wasInterrupted) {
                finalScoreMessageEl.innerHTML = `<span class="text-red-500 font-bold">คู่ต่อสู้ของคุณออกจากเกมไปแล้ว</span><br>โปรดกลับสู่ล็อบบี้เพื่อเริ่มใหม่`;
                
                updatePlayerStatus('Online');
                setView('game-over');
                return;
            }

            const opponentId = getOpponentId(gameData);
            const opponentNickname = gameData.players[opponentId].nickname;
            
            finalScoreMessageEl.innerHTML = `
                คุณเล่นกับ ${opponentNickname} ครบ ${totalQuestions} คำถามแล้ว!<br>
                <span class="text-blue-600 font-bold text-2xl">จบเกม!</span>
            `;

            updatePlayerStatus('Online');
            setView('game-over');
        }

        // --- Event Listeners Setup (ไม่ได้เปลี่ยนแปลง) ---

        joinBtn.addEventListener('click', async () => {
            const inputNickname = nicknameInputEl.value.trim();
            if (inputNickname.length < 2 || inputNickname.length > 15) {
                showGlobalMessage('ชื่อเล่นต้องมีความยาวระหว่าง 2 ถึง 15 ตัวอักษร', 'error');
                return;
            }
            nickname = inputNickname;
            setView('lobby');
            updatePlayerStatus('Online'); 
            startListeningToLobby(); 
            
            const q = query(
                getPublicCollectionRef('games'),
                where('opponentId', '==', userId),
                where('status', '==', 'WAITING_FOR_INVITE')
            );
            // Listener สำหรับรับคำเชิญที่ส่งมาถึงเรา
            onSnapshot(q, (snapshot) => {
                if (snapshot.docs.length > 0 && currentGameId === null) {
                    const invitationDoc = snapshot.docs[0];
                    startListeningToGame(invitationDoc.id); 
                }
            });
        });
        
        onlineUsersListEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('invite-btn')) {
                const opponentId = e.target.dataset.id;
                const opponentNickname = e.target.dataset.name;
                createGame(opponentId, opponentNickname);
            }
        });
        
        choiceABtn.addEventListener('click', () => handleChoiceSelection(0));
        choiceBBtn.addEventListener('click', () => handleChoiceSelection(1));

        nextRoundBtn.addEventListener('click', nextRound);
        
        acceptInviteBtn.addEventListener('click', () => acceptInvitation(currentGameId));
        declineInviteBtn.addEventListener('click', () => declineInvitation(currentGameId));

        backToLobbyBtn.addEventListener('click', () => leaveGame()); 

        // --- Firebase Initialization ---

        async function initFirebase() {
            const firebaseConfig = USER_FIREBASE_CONFIG;
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ใช้ Anonymous Sign-In เสมอ
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                isAuthReady = true;
                
                // ลบสถานะออนไลน์เก่าออก 
                await deleteDoc(getPublicDocRef('onlineUsers', userId)).catch(e => console.log('No old presence record to delete.'));
                
                setView('nickname'); 

            } catch (error) {
                console.error("Firebase initialization or auth failed:", error);
                showGlobalMessage('ข้อผิดพลาดในการเชื่อมต่อ: กรุณาตรวจสอบ Firebase Config หรือสถานะบริการ', 'error');
            }
        }
        
        // ตรวจสอบกฎความปลอดภัยของ Firestore
        console.warn(`*** สำคัญ: ตรวจสอบให้แน่ใจว่า Firestore Security Rules ของคุณอนุญาตให้ผู้ใช้ที่เข้าสู่ระบบแบบไม่ระบุชื่อ (Authenticated) อ่านและเขียนในพาธ /artifacts/${APP_IDENTIFIER}/public/data/... ได้ ***`);

        window.onload = initFirebase;

    </script>

</body>
</html>
