<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมเลือกฝั่ง (This or That)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .btn {
            @apply w-full px-4 py-3 text-lg font-bold text-white rounded-lg shadow-md transition-transform duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-600 active:scale-95;
        }
        .btn-secondary {
            @apply bg-green-500 hover:bg-green-600 active:scale-95;
        }
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        .card {
            @apply bg-white p-6 md:p-8 rounded-xl shadow-2xl;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <!-- Login Screen -->
        <div id="login-screen" class="card text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">เกมเลือกฝั่ง</h1>
            <p class="text-gray-500 mb-6">ใส่ชื่อของคุณเพื่อเริ่มเล่นกับเพื่อนๆ</p>
            <input type="text" id="name-input" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="ชื่อของคุณ...">
            <button id="login-button" class="btn btn-primary">เข้าสู่ระบบ</button>
            <p id="login-error" class="text-red-500 mt-2 hidden">กรุณาใส่ชื่อของคุณ</p>
        </div>

        <!-- Lobby Screen (New Lobby System) -->
        <div id="lobby-screen" class="hidden">
            <div class="card mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-1">สวัสดี, <span id="user-name-display" class="text-blue-500"></span>!</h2>
                <p class="text-gray-500 mb-4">เลือกห้องเพื่อเข้าร่วม หรือสร้างห้องใหม่</p>

                <!-- Create Room Button -->
                <button id="create-room-button" class="btn bg-red-500 hover:bg-red-600 active:scale-95 mb-4">
                    สร้างห้องใหม่ (1 VS 1)
                </button>
            </div>
            
            <!-- Available Rooms List -->
            <div class="card">
                <h3 class="text-xl font-bold mb-3 flex justify-between items-center">
                    ห้องที่เปิดรออยู่ <span id="room-count" class="text-gray-400 text-sm">(0 ห้อง)</span>
                </h3>
                <ul id="rooms-list" class="space-y-3">
                    <li class="text-center text-gray-400">กำลังโหลดห้อง...</li>
                </ul>
            </div>

            <div class="mt-4 text-center text-xs text-gray-400">
                <p>User ID ของคุณ: <span id="user-id-display"></span></p>
            </div>
        </div>

        <!-- Game Screen (No change in core game elements) -->
        <div id="game-screen" class="hidden">
            <div class="card text-center">
                <div class="flex justify-between items-center mb-4 text-sm font-semibold">
                    <span id="player1-name" class="text-blue-600 bg-blue-100 px-3 py-1 rounded-full"></span>
                    <span class="text-gray-500">VS</span>
                    <span id="player2-name" class="text-green-600 bg-green-100 px-3 py-1 rounded-full"></span>
                </div>

                <h2 id="question-counter" class="text-xl font-bold text-gray-700 mb-2">คำถามที่ 1</h2>
                <p id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 h-24 flex items-center justify-center">คำถาม...</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button id="option-a-button" class="btn bg-pink-500 hover:bg-pink-600 active:scale-95"></button>
                    <button id="option-b-button" class="btn bg-indigo-500 hover:bg-indigo-600 active:scale-95"></button>
                </div>
                
                <div id="game-status" class="mt-4 h-12 flex items-center justify-center">
                     <p class="text-gray-500">กรุณาเลือกคำตอบของคุณ</p>
                </div>

                <div id="result-display" class="hidden mt-4 text-lg space-y-2">
                    <p id="player1-choice"></p>
                    <p id="player2-choice"></p>
                </div>

                <button id="next-question-button" class="btn btn-secondary mt-4 hidden">คำถามต่อไป</button>
                 <button id="end-game-button" class="btn bg-red-500 hover:bg-red-600 active:scale-95 mt-4 hidden">จบเกมและกลับไปที่ล็อบบี้</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, push, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- Firebase Config ---
        // **ย้ำอีกครั้ง: ต้องตั้งค่า Realtime Database Rules ให้เป็น ".read": "true", ".write": "true" เพื่อให้ระบบนี้ทำงานได้**
        const firebaseConfig = {
            apiKey: "AIzaSyA4VP_-06lqomseyhewH6Iv6eOMPwG8nnU",
            authDomain: "game-8ede6.firebaseapp.com",
            databaseURL: "https://game-8ede6-default-rtdb.firebaseio.com",
            projectId: "game-8ede6",
            storageBucket: "game-8ede6.appspot.com",
            messagingSenderId: "206374174939",
            appId: "1:206374174939:web:48556411426f53859a4cfe",
            measurementId: "G-KG84KJ11VC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const nameInput = document.getElementById('name-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const userNameDisplay = document.getElementById('user-name-display');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // New/Updated Lobby Elements
        const createRoomButton = document.getElementById('create-room-button');
        const roomsList = document.getElementById('rooms-list');
        const roomCount = document.getElementById('room-count');
        
        // Game screen elements (unchanged)
        const player1Name = document.getElementById('player1-name');
        const player2Name = document.getElementById('player2-name');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const optionAButton = document.getElementById('option-a-button');
        const optionBButton = document.getElementById('option-b-button');
        const gameStatus = document.getElementById('game-status');
        const resultDisplay = document.getElementById('result-display');
        const player1Choice = document.getElementById('player1-choice');
        const player2Choice = document.getElementById('player2-choice');
        const nextQuestionButton = document.getElementById('next-question-button');
        const endGameButton = document.getElementById('end-game-button');

        // --- Game State ---
        let userId;
        let userName;
        let currentGameId = null;
        let gameListener = null;

        const questions = [
            { a: "แมว", b: "หมา" },
            { a: "ทะเล", b: "ภูเขา" },
            { a: "กาแฟ", b: "ชา" },
            { a: "ดูหนังที่บ้าน", b: "ดูหนังในโรง" },
            { a: "กลางคืน", b: "กลางวัน" },
            { a: "พิซซ่า", b: "เบอร์เกอร์" },
            { a: "ร้องเพลง", b: "เต้น" },
            { a: "อ่านหนังสือ", b: "ฟังเพลง" },
            { a: "อยู่คนเดียว", b: "อยู่กับเพื่อน" },
            { a: "เงิน", b: "ความรัก" },
        ];

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                const userRef = ref(db, `users/${userId}`);
                
                get(userRef).then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().name) {
                        completeLoginAndSetup(snapshot.val().name, userRef);
                    } else {
                        showScreen('login');
                    }
                }).catch(error => {
                    console.error("Error checking existing user data (Check Rules!):", error);
                    showScreen('login');
                });
            } else {
                signInAnonymously(auth).catch((error) => console.error("Anonymous sign in failed", error));
            }
        });
        
        /**
         * Ensures user data is written before starting lobby listeners and sets up presence.
         */
        function completeLoginAndSetup(name, userRef) {
            userName = name;
            userNameDisplay.textContent = userName;

            // 1. Write initial/current user data to DB
            set(userRef, {
                name: userName,
                online: true,
                status: 'idle'
            }).catch(error => console.error("Error setting initial user data (Check Write Rules!):", error));

            // 2. Set Presence (On Disconnect) - Clean up room if user leaves while waiting
            onValue(ref(db, '.info/connected'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, `users/${userId}/online`), true); 
                    
                    const onDisconnectRef = onDisconnect(userRef);
                    onDisconnectRef.update({ online: false, status: 'offline' })
                        .catch(error => console.error("Error setting onDisconnect user status:", error));
                    
                    // Clean up any room the user created if they leave while waiting
                    get(ref(db, `users/${userId}/currentRoomId`)).then(snapshot => {
                        if (snapshot.exists()) {
                            const currentRoomId = snapshot.val();
                            if (currentRoomId) {
                                onDisconnect(ref(db, `publicRooms/${currentRoomId}`)).remove()
                                    .catch(error => console.error("Error setting onDisconnect room removal:", error));
                            }
                        }
                    });

                }
            }, (error) => console.error("Error checking connection status:", error));


            // 3. Start Lobby listeners
            setupLobby(userRef);
        }


        // --- UI Control ---
        function showScreen(screenName) {
            loginScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');
        }

        // --- Login Logic ---
        loginButton.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                const userRef = ref(db, `users/${userId}`);
                completeLoginAndSetup(name, userRef);
                loginError.classList.add('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        // --- Lobby System Logic (New) ---
        function setupLobby(userRef) {
            showScreen('lobby');
            listenForRooms();
            listenForGameStart(userRef);

            createRoomButton.onclick = createRoom;
        }

        function createRoom() {
            createRoomButton.classList.add('btn-disabled');
            createRoomButton.textContent = 'กำลังสร้างห้อง...';
            createRoomButton.onclick = null;

            const roomRef = push(ref(db, 'publicRooms'));
            const roomId = roomRef.key;

            const roomData = {
                creatorId: userId,
                creatorName: userName,
                status: 'waiting', // Waiting for player 2
                createdAt: Date.now()
            };

            // 1. Write room data
            set(roomRef, roomData)
            .then(() => {
                // 2. Update user status and link to the room
                return update(ref(db, `users/${userId}`), {
                    status: 'waiting', // New status for waiting in lobby
                    currentRoomId: roomId
                });
            })
            .then(() => {
                console.log(`Room created: ${roomId}. Waiting for player 2.`);
                // UI feedback is handled by listenForRooms and listenForGameStart
            })
            .catch(error => {
                console.error("Error creating room:", error);
                // Reset button on failure
                resetCreateRoomButton();
                // Show error message
                roomsList.insertAdjacentHTML('afterbegin', 
                    `<li class="text-center text-red-500 font-bold bg-red-50 p-3 rounded-lg border border-red-300">
                        สร้างห้องล้มเหลว! โปรดตรวจสอบการเชื่อมต่อและกฎ Write Rules
                    </li>`);
            });
        }
        
        function resetCreateRoomButton() {
            createRoomButton.classList.remove('btn-disabled');
            createRoomButton.textContent = 'สร้างห้องใหม่ (1 VS 1)';
            createRoomButton.onclick = createRoom;
        }


        function listenForRooms() {
            const roomsRef = ref(db, 'publicRooms');
            
            // แสดงสถานะ "กำลังโหลด" ขณะรอข้อมูล
            roomsList.innerHTML = '<li class="text-center text-gray-400">กำลังโหลดห้อง...</li>'; 

            onValue(roomsRef, (snapshot) => {
                roomsList.innerHTML = '';
                const rooms = snapshot.val();
                const roomKeys = rooms ? Object.keys(rooms) : [];
                
                roomCount.textContent = `(${roomKeys.length} ห้อง)`;

                if (roomKeys.length > 0) {
                    roomKeys.forEach(roomId => {
                        const room = rooms[roomId];
                        
                        // ไม่แสดงห้องที่ตัวเองสร้างและกำลังรออยู่ (เพื่อไม่ให้ Join ตัวเอง)
                        if (room.creatorId === userId && room.status === 'waiting') {
                             roomsList.insertAdjacentHTML('afterbegin', `
                                <li id="my-waiting-room" class="flex justify-between items-center bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-500">
                                    <span class="font-bold text-yellow-800">ห้องของคุณ: ${room.creatorName}</span>
                                    <span class="text-sm text-yellow-600">รอผู้เล่น...</span>
                                </li>
                            `);
                             // Disable create room button if already waiting in a room
                             createRoomButton.classList.add('btn-disabled');
                             createRoomButton.textContent = 'คุณกำลังรอในห้อง...';
                             createRoomButton.onclick = null;
                            return;
                        }

                        // แสดงห้องที่คนอื่นสร้างและพร้อมเข้าร่วม
                        if (room.status === 'waiting' && room.creatorId !== userId) {
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border-l-4 border-blue-500';
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.innerHTML = `<span class="font-semibold">${room.creatorName}</span> <span class="text-gray-500 text-sm">กำลังรอ</span>`;
                            li.appendChild(nameSpan);

                            const joinButton = document.createElement('button');
                            joinButton.textContent = 'เข้าร่วม';
                            joinButton.className = 'bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600';
                            joinButton.onclick = () => joinRoom(roomId, room.creatorId, room.creatorName);
                            li.appendChild(joinButton);
                            roomsList.appendChild(li);
                        }
                    });
                }
                
                // If no rooms are available or I'm waiting in my room
                if (roomKeys.length === 0) {
                    roomsList.innerHTML = '<li class="text-center text-gray-400">ยังไม่มีห้องที่เปิดรออยู่</li>';
                }

                // If my room is not found (meaning the game started or my room was deleted)
                const myRoomElement = document.getElementById('my-waiting-room');
                if (!myRoomElement && roomKeys.some(id => rooms[id].creatorId === userId && rooms[id].status === 'waiting')) {
                    // Do nothing, still waiting, listener handles my room
                } else if (!roomKeys.some(id => rooms[id].creatorId === userId)) {
                    // Reset button if I'm not waiting in any room
                    resetCreateRoomButton();
                }

            }, (error) => {
                 // แสดงข้อความใน UI และ Console หากการเชื่อมต่อมีปัญหา
                 console.error("Firebase Read Error (Check Rules!):", error);
                 roomsList.innerHTML = '<li class="text-center text-red-600 font-bold bg-red-50 p-3 rounded-lg border border-red-300">ไม่สามารถโหลดรายชื่อห้องได้! <br/>โปรดตรวจสอบกฎความปลอดภัยของ Realtime Database ให้เป็น ".read": "true"</li>';
            });
        }
        
        function joinRoom(roomId, creatorId, creatorName) {
             const gameId = push(ref(db, 'games')).key;
             const shuffledQuestions = [...questions].sort(() => 0.5 - Math.random());
             
             const gameData = {
                 player1: { id: creatorId, name: creatorName, choice: null }, // Creator is Player 1
                 player2: { id: userId, name: userName, choice: null },       // Joiner is Player 2
                 currentQuestionIndex: 0,
                 questions: shuffledQuestions,
                 status: 'playing'
             };

             // 1. สร้างเกมใหม่
             // 2. อัปเดตสถานะผู้เล่นทั้งสอง
             // 3. ลบห้องสาธารณะทิ้ง
             const updates = {};
             updates[`games/${gameId}`] = gameData;
             updates[`users/${creatorId}/status`] = 'in-game';
             updates[`users/${creatorId}/currentGameId`] = gameId;
             updates[`users/${creatorId}/currentRoomId`] = null; // Clear room ID
             updates[`users/${userId}/status`] = 'in-game';
             updates[`users/${userId}/currentGameId`] = gameId;
             updates[`publicRooms/${roomId}`] = null; // Delete the room

             update(ref(db), updates)
                 .then(() => {
                    console.log(`Game started: ${gameId}`);
                    // Player 1 (Creator) will automatically receive the update via listenForGameStart
                    // Player 2 (Joiner) will also go to game screen via listenForGameStart
                 })
                 .catch(error => {
                     console.error("Error joining room and starting game:", error);
                     alert('ไม่สามารถเข้าร่วมเกมได้! โปรดลองใหม่');
                 });
        }

        function listenForGameStart(userRef) {
            // ฟังการเปลี่ยนแปลงในข้อมูลผู้ใช้ของตัวเอง
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // หากสถานะเปลี่ยนเป็น 'in-game' และมี currentGameId ใหม่
                    if (data.status === 'in-game' && data.currentGameId && currentGameId !== data.currentGameId) {
                        startGame(data.currentGameId);
                    } 
                    // หากออกจากเกมแล้ว แต่ยังค้าง currentGameId อยู่
                    else if (data.status !== 'in-game' && currentGameId) {
                        cleanUpAfterGame(false); 
                    }
                    // หากสถานะเปลี่ยนจาก 'waiting' เป็น 'idle'
                    else if (data.status === 'idle') {
                         resetCreateRoomButton();
                    }
                }
            }, (error) => console.error("Error listening for game start on user ref:", error));
        }

        // --- Game Logic (Unchanged core logic) ---
        function startGame(gameId) {
            if (gameListener) {
                gameListener(); 
            }
            currentGameId = gameId;
            showScreen('game');

            const gameRef = ref(db, `games/${currentGameId}`);
            gameListener = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    if(currentGameId){ 
                        document.getElementById('app-container').insertAdjacentHTML('afterbegin', 
                            `<div id="game-ended" class="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center font-bold">
                                เกมสิ้นสุดลงแล้ว หรือผู้เล่นอีกฝ่ายออกไปแล้ว
                            </div>`
                        );
                        setTimeout(() => {
                            const endMsg = document.getElementById('game-ended');
                            if(endMsg) endMsg.remove();
                        }, 5000);
                        cleanUpAfterGame(true);
                    }
                    return;
                }
                const gameState = snapshot.val();
                renderGameState(gameState);
            }, (error) => console.error("Error listening to game state:", error));
        }

        function renderGameState(state) {
            if (!state) return;
            const isPlayer1 = state.player1.id === userId;
            const me = isPlayer1 ? state.player1 : state.player2;
            const opponent = isPlayer1 ? state.player2 : state.player1;
            
            player1Name.textContent = state.player1.name;
            player2Name.textContent = state.player2.name;

            if (state.status === 'finished') {
                questionText.textContent = "เกมจบแล้ว!";
                optionAButton.classList.add('hidden');
                optionBButton.classList.add('hidden');
                gameStatus.innerHTML = '<p class="font-bold text-green-600">ขอบคุณที่เล่น!</p>';
                nextQuestionButton.classList.add('hidden');
                resultDisplay.classList.add('hidden');
                endGameButton.classList.remove('hidden');
                return;
            }

            const question = state.questions[state.currentQuestionIndex];
            questionCounter.textContent = `คำถามที่ ${state.currentQuestionIndex + 1}/${state.questions.length}`;
            questionText.textContent = `${question.a} หรือ ${question.b}`;
            optionAButton.textContent = question.a;
            optionBButton.textContent = question.b;

            optionAButton.onclick = () => makeChoice('a');
            optionBButton.onclick = () => makeChoice('b');

            const bothChosen = me.choice && opponent.choice;
            
            if (bothChosen) {
                gameStatus.classList.add('hidden');
                resultDisplay.classList.remove('hidden');
                
                player1Choice.textContent = `${state.player1.name} เลือก: ${state.questions[state.currentQuestionIndex][state.player1.choice]}`;
                player2Choice.textContent = `${state.player2.name} เลือก: ${state.questions[state.currentQuestionIndex][state.player2.choice]}`;

                optionAButton.classList.add('btn-disabled');
                optionBButton.classList.add('btn-disabled');
                optionAButton.onclick = null;
                optionBButton.onclick = null;
                nextQuestionButton.classList.remove('hidden');
            } else if (me.choice) {
                gameStatus.classList.remove('hidden');
                gameStatus.innerHTML = '<p class="text-yellow-500 font-bold">รอผู้เล่นอีกคนเลือก...</p>';
                resultDisplay.classList.add('hidden');
                optionAButton.classList.add('btn-disabled');
                optionBButton.classList.add('btn-disabled');
                optionAButton.onclick = null;
                optionBButton.onclick = null;
                nextQuestionButton.classList.add('hidden');
            } else {
                gameStatus.classList.remove('hidden');
                gameStatus.innerHTML = '<p class="text-gray-500">กรุณาเลือกคำตอบของคุณ</p>';
                resultDisplay.classList.add('hidden');
                optionAButton.classList.remove('btn-disabled');
                optionBButton.classList.remove('btn-disabled');
                nextQuestionButton.classList.add('hidden');
            }
        }

        function makeChoice(choice) {
            get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                const state = snapshot.val();
                if(state){
                    const playerKey = state.player1.id === userId ? 'player1' : 'player2';
                    update(ref(db), {
                        [`games/${currentGameId}/${playerKey}/choice`]: choice
                    }).catch(error => console.error("Error making choice:", error));
                }
            });
        }
        
        nextQuestionButton.addEventListener('click', () => {
             get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                const state = snapshot.val();
                if (!state) return;
                const nextIndex = state.currentQuestionIndex + 1;
                
                const updates = {};
                if (nextIndex < state.questions.length) {
                    updates[`games/${currentGameId}/currentQuestionIndex`] = nextIndex;
                    updates[`games/${currentGameId}/player1/choice`] = null;
                    updates[`games/${currentGameId}/player2/choice`] = null;
                } else {
                    updates[`games/${currentGameId}/status`] = 'finished';
                }
                update(ref(db), updates).catch(error => console.error("Error moving to next question:", error));
             });
        });

        endGameButton.addEventListener('click', () => {
             get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                if(snapshot.exists()) {
                    const state = snapshot.val();
                    const updates = {};
                    
                    // ตั้งค่าสถานะผู้เล่นกลับเป็น 'idle' และล้าง currentGameId
                    updates[`users/${state.player1.id}/status`] = 'idle';
                    updates[`users/${state.player1.id}/currentGameId`] = null;
                    updates[`users/${state.player2.id}/status`] = 'idle';
                    updates[`users/${state.player2.id}/currentGameId`] = null;
                    
                    // ลบเกม
                    updates[`games/${currentGameId}`] = null;
                    
                    update(ref(db), updates).catch(error => console.error("Error ending game:", error));
                }
             });
             cleanUpAfterGame(true);
        });

        function cleanUpAfterGame(shouldGoToLobby = true) {
            // ล้างสถานะภายในเครื่องและใน DB
            update(ref(db, `users/${userId}`), {
                status: 'idle', 
                currentGameId: null,
                currentRoomId: null // Clear room ID
            }).catch(error => console.error("Error cleaning up user data:", error));

            currentGameId = null;
            if (gameListener) {
                gameListener(); 
                gameListener = null;
            }
            
            optionAButton.classList.remove('hidden');
            optionBButton.classList.remove('hidden');
            endGameButton.classList.add('hidden');

            if(shouldGoToLobby) {
                setupLobby(ref(db, `users/${userId}`));
            }
        }
    </script>
</body>
</html>
