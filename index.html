<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมเลือกฝั่ง (This or That)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .btn {
            @apply w-full px-4 py-3 text-lg font-bold text-white rounded-lg shadow-md transition-transform duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-600 active:scale-95;
        }
        .btn-secondary {
            @apply bg-green-500 hover:bg-green-600 active:scale-95;
        }
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        .card {
            @apply bg-white p-6 md:p-8 rounded-xl shadow-2xl;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <!-- Login Screen -->
        <div id="login-screen" class="card text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">เกมเลือกฝั่ง</h1>
            <p class="text-gray-500 mb-6">ใส่ชื่อของคุณเพื่อเริ่มเล่นกับเพื่อนๆ</p>
            <input type="text" id="name-input" class="w-full px-4 py-2 border rounded-lg mb-4" placeholder="ชื่อของคุณ...">
            <button id="login-button" class="btn btn-primary">เข้าสู่ระบบ</button>
            <p id="login-error" class="text-red-500 mt-2 hidden">กรุณาใส่ชื่อของคุณ</p>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden">
            <div class="card mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-1">สวัสดี, <span id="user-name-display" class="text-blue-500"></span>!</h2>
                <p class="text-gray-500">เชิญผู้เล่นที่ออนไลน์อยู่เพื่อเริ่มเกม</p>
            </div>

            <div class="card mb-4">
                <h3 class="text-xl font-bold mb-3">คำเชิญ</h3>
                <div id="invitations-list" class="space-y-2">
                    <p class="text-gray-400">ยังไม่มีคำเชิญ...</p>
                </div>
            </div>

            <div class="card">
                <h3 class="text-xl font-bold mb-3">ผู้เล่นที่ออนไลน์</h3>
                <ul id="player-list" class="space-y-2">
                    <li class="text-center text-gray-400">กำลังโหลดรายชื่อผู้เล่น...</li>
                </ul>
            </div>
             <div class="mt-4 text-center text-xs text-gray-400">
                <p>User ID ของคุณ: <span id="user-id-display"></span></p>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="card text-center">
                <div class="flex justify-between items-center mb-4 text-sm font-semibold">
                    <span id="player1-name" class="text-blue-600 bg-blue-100 px-3 py-1 rounded-full"></span>
                    <span class="text-gray-500">VS</span>
                    <span id="player2-name" class="text-green-600 bg-green-100 px-3 py-1 rounded-full"></span>
                </div>

                <h2 id="question-counter" class="text-xl font-bold text-gray-700 mb-2">คำถามที่ 1</h2>
                <p id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 h-24 flex items-center justify-center">คำถาม...</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button id="option-a-button" class="btn bg-pink-500 hover:bg-pink-600 active:scale-95"></button>
                    <button id="option-b-button" class="btn bg-indigo-500 hover:bg-indigo-600 active:scale-95"></button>
                </div>
                
                <div id="game-status" class="mt-4 h-12 flex items-center justify-center">
                     <p class="text-gray-500">กรุณาเลือกคำตอบของคุณ</p>
                </div>

                <div id="result-display" class="hidden mt-4 text-lg space-y-2">
                    <p id="player1-choice"></p>
                    <p id="player2-choice"></p>
                </div>

                <button id="next-question-button" class="btn btn-secondary mt-4 hidden">คำถามต่อไป</button>
                 <button id="end-game-button" class="btn bg-red-500 hover:bg-red-600 active:scale-95 mt-4 hidden">จบเกมและกลับไปที่ล็อบบี้</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, push, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- Firebase Config ---
        // Make sure your Realtime Database rules are set to public for this to work.
        // { "rules": { ".read": "true", ".write": "true" } }
        const firebaseConfig = {
            apiKey: "AIzaSyA4VP_-06lqomseyhewH6Iv6eOMPwG8nnU",
            authDomain: "game-8ede6.firebaseapp.com",
            databaseURL: "https://game-8ede6-default-rtdb.firebaseio.com",
            projectId: "game-8ede6",
            storageBucket: "game-8ede6.appspot.com",
            messagingSenderId: "206374174939",
            appId: "1:206374174939:web:48556411426f53859a4cfe",
            measurementId: "G-KG84KJ11VC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const nameInput = document.getElementById('name-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const userNameDisplay = document.getElementById('user-name-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const playerList = document.getElementById('player-list');
        const invitationsList = document.getElementById('invitations-list');
        
        // Game screen elements
        const player1Name = document.getElementById('player1-name');
        const player2Name = document.getElementById('player2-name');
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const optionAButton = document.getElementById('option-a-button');
        const optionBButton = document.getElementById('option-b-button');
        const gameStatus = document.getElementById('game-status');
        const resultDisplay = document.getElementById('result-display');
        const player1Choice = document.getElementById('player1-choice');
        const player2Choice = document.getElementById('player2-choice');
        const nextQuestionButton = document.getElementById('next-question-button');
        const endGameButton = document.getElementById('end-game-button');

        // --- Game State ---
        let userId;
        let userName;
        let currentGameId = null;
        let gameListener = null;

        const questions = [
            { a: "แมว", b: "หมา" },
            { a: "ทะเล", b: "ภูเขา" },
            { a: "กาแฟ", b: "ชา" },
            { a: "ดูหนังที่บ้าน", b: "ดูหนังในโรง" },
            { a: "กลางคืน", b: "กลางวัน" },
            { a: "พิซซ่า", b: "เบอร์เกอร์" },
            { a: "ร้องเพลง", b: "เต้น" },
            { a: "อ่านหนังสือ", b: "ฟังเพลง" },
            { a: "อยู่คนเดียว", b: "อยู่กับเพื่อน" },
            { a: "เงิน", b: "ความรัก" },
        ];

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                const userRef = ref(db, `users/${userId}`);
                
                // Set presence: when connected, set online true. when disconnected, set to false.
                const presenceRef = ref(db, `users/${userId}/online`);
                onValue(ref(db, '.info/connected'), (snap) => {
                    if (snap.val() === true) {
                        set(presenceRef, true);
                        onDisconnect(userRef).update({ online: false, status: 'offline' });
                    }
                });

                // Check if user already has a name from a previous session
                get(userRef).then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().name) {
                        userName = snapshot.val().name;
                        setupLobby(userRef);
                    } else {
                        showScreen('login');
                    }
                });
            } else {
                signInAnonymously(auth).catch((error) => console.error("Anonymous sign in failed", error));
            }
        });

        // --- UI Control ---
        function showScreen(screenName) {
            loginScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');
        }

        // --- Login Logic ---
        loginButton.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                userName = name;
                const userRef = ref(db, `users/${userId}`);
                set(userRef, {
                    name: userName,
                    online: true,
                    status: 'idle'
                });
                setupLobby(userRef);
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        // --- Lobby Logic ---
        function setupLobby(userRef) {
            userNameDisplay.textContent = userName;
            showScreen('lobby');
            listenForPlayers();
            listenForInvitations();
            listenForGameStart(userRef);
        }

        function listenForPlayers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                playerList.innerHTML = '';
                const users = snapshot.val();
                let onlineCount = 0;
                if (users) {
                    Object.keys(users).forEach(uid => {
                        if (users[uid].online && uid !== userId) {
                            onlineCount++;
                            const user = users[uid];
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = `${user.name} (${user.status === 'in-game' ? 'กำลังเล่น' : 'ว่าง'})`;
                            li.appendChild(nameSpan);

                            if(user.status === 'idle') {
                                const inviteButton = document.createElement('button');
                                inviteButton.textContent = 'เชิญ';
                                inviteButton.className = 'bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600';
                                inviteButton.onclick = () => sendInvitation(uid, user.name);
                                li.appendChild(inviteButton);
                            }
                            playerList.appendChild(li);
                        }
                    });
                }
                if (onlineCount === 0) {
                    playerList.innerHTML = '<li class="text-center text-gray-400">ไม่มีผู้เล่นอื่นออนไลน์</li>';
                }
            });
        }
        
        function sendInvitation(targetId, targetName) {
            const invitationRef = ref(db, `invitations/${targetId}/${userId}`);
            set(invitationRef, {
                senderName: userName,
                senderId: userId
            });
            alert(`ส่งคำเชิญไปที่ ${targetName} แล้ว`);
        }

        function listenForInvitations() {
             const invitationsRef = ref(db, `invitations/${userId}`);
             onValue(invitationsRef, (snapshot) => {
                invitationsList.innerHTML = '';
                const invitations = snapshot.val();
                if(invitations) {
                    Object.keys(invitations).forEach(senderId => {
                        const inv = invitations[senderId];
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center bg-green-50 p-2 rounded-lg';
                        div.innerHTML = `<span>${inv.senderName} ชวนคุณเล่นเกม</span>`;
                        
                        const acceptButton = document.createElement('button');
                        acceptButton.textContent = 'ยอมรับ';
                        acceptButton.className = 'bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600';
                        acceptButton.onclick = () => acceptInvitation(senderId);
                        div.appendChild(acceptButton);
                        invitationsList.appendChild(div);
                    });
                } else {
                    invitationsList.innerHTML = '<p class="text-gray-400">ยังไม่มีคำเชิญ...</p>';
                }
             });
        }
        
        function acceptInvitation(senderId) {
            const gameId = push(ref(db, 'games')).key;
            const shuffledQuestions = [...questions].sort(() => 0.5 - Math.random());

            const gameData = {
                player1: { id: senderId, name: 'Loading...', choice: null },
                player2: { id: userId, name: userName, choice: null },
                currentQuestionIndex: 0,
                questions: shuffledQuestions,
                status: 'playing'
            };
            
            get(ref(db, `users/${senderId}/name`)).then(snapshot => {
                if(snapshot.exists()) {
                     gameData.player1.name = snapshot.val();
                     set(ref(db, `games/${gameId}`), gameData);
                }
            });

            // Update player statuses to trigger game start for both
            const updates = {};
            updates[`users/${userId}/status`] = 'in-game';
            updates[`users/${userId}/currentGameId`] = gameId;
            updates[`users/${senderId}/status`] = 'in-game';
            updates[`users/${senderId}/currentGameId`] = gameId;
            
            // Clean up all invitations for both players
            updates[`invitations/${userId}`] = null;
            updates[`invitations/${senderId}`] = null;

            ref(db).update(updates);
        }

        function listenForGameStart(userRef) {
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.status === 'in-game' && data.currentGameId && currentGameId !== data.currentGameId) {
                    startGame(data.currentGameId);
                }
            });
        }

        // --- Game Logic ---
        function startGame(gameId) {
            currentGameId = gameId;
            showScreen('game');

            const gameRef = ref(db, `games/${currentGameId}`);
            gameListener = onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    if(currentGameId){ // Only show alert if we were actually in a game
                        alert('เกมสิ้นสุดลงแล้ว หรือผู้เล่นอีกฝ่ายออกไปแล้ว');
                        cleanUpAfterGame();
                    }
                    return;
                }
                const gameState = snapshot.val();
                renderGameState(gameState);
            });
        }

        function renderGameState(state) {
            if (!state) return;
            const isPlayer1 = state.player1.id === userId;
            const me = isPlayer1 ? state.player1 : state.player2;
            const opponent = isPlayer1 ? state.player2 : state.player1;
            
            player1Name.textContent = state.player1.name;
            player2Name.textContent = state.player2.name;

            if (state.status === 'finished') {
                questionText.textContent = "เกมจบแล้ว!";
                optionAButton.classList.add('hidden');
                optionBButton.classList.add('hidden');
                gameStatus.innerHTML = '<p class="font-bold text-green-600">ขอบคุณที่เล่น!</p>';
                nextQuestionButton.classList.add('hidden');
                resultDisplay.classList.add('hidden');
                endGameButton.classList.remove('hidden');
                return;
            }

            const question = state.questions[state.currentQuestionIndex];
            questionCounter.textContent = `คำถามที่ ${state.currentQuestionIndex + 1}/${state.questions.length}`;
            questionText.textContent = `${question.a} หรือ ${question.b}`;
            optionAButton.textContent = question.a;
            optionBButton.textContent = question.b;

            optionAButton.onclick = () => makeChoice('a');
            optionBButton.onclick = () => makeChoice('b');

            const bothChosen = me.choice && opponent.choice;
            
            if (bothChosen) {
                gameStatus.classList.add('hidden');
                resultDisplay.classList.remove('hidden');
                
                player1Choice.textContent = `${state.player1.name} เลือก: ${state.questions[state.currentQuestionIndex][state.player1.choice]}`;
                player2Choice.textContent = `${state.player2.name} เลือก: ${state.questions[state.currentQuestionIndex][state.player2.choice]}`;

                optionAButton.classList.add('btn-disabled');
                optionBButton.classList.add('btn-disabled');
                optionAButton.onclick = null;
                optionBButton.onclick = null;
                nextQuestionButton.classList.remove('hidden');
            } else if (me.choice) {
                gameStatus.classList.remove('hidden');
                gameStatus.innerHTML = '<p class="text-yellow-500 font-bold">รอผู้เล่นอีกคนเลือก...</p>';
                resultDisplay.classList.add('hidden');
                optionAButton.classList.add('btn-disabled');
                optionBButton.classList.add('btn-disabled');
                optionAButton.onclick = null;
                optionBButton.onclick = null;
                nextQuestionButton.classList.add('hidden');
            } else {
                gameStatus.classList.remove('hidden');
                gameStatus.innerHTML = '<p class="text-gray-500">กรุณาเลือกคำตอบของคุณ</p>';
                resultDisplay.classList.add('hidden');
                optionAButton.classList.remove('btn-disabled');
                optionBButton.classList.remove('btn-disabled');
                nextQuestionButton.classList.add('hidden');
            }
        }

        function makeChoice(choice) {
            const playerKey = ref(db, `games/${currentGameId}`).child(userId === get(ref(db, `games/${currentGameId}/player1/id`)) ? 'player1' : 'player2');
            get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                const state = snapshot.val();
                if(state){
                    const playerKey = state.player1.id === userId ? 'player1' : 'player2';
                    set(ref(db, `games/${currentGameId}/${playerKey}/choice`), choice);
                }
            });
        }
        
        nextQuestionButton.addEventListener('click', () => {
             const updates = {};
             get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                const state = snapshot.val();
                if (!state) return;
                const nextIndex = state.currentQuestionIndex + 1;
                
                if (nextIndex < state.questions.length) {
                    updates[`games/${currentGameId}/currentQuestionIndex`] = nextIndex;
                    updates[`games/${currentGameId}/player1/choice`] = null;
                    updates[`games/${currentGameId}/player2/choice`] = null;
                } else {
                    updates[`games/${currentGameId}/status`] = 'finished';
                }
                ref(db).update(updates);
             });
        });

        endGameButton.addEventListener('click', () => {
             get(ref(db, `games/${currentGameId}`)).then(snapshot => {
                if(snapshot.exists()) {
                    const state = snapshot.val();
                    const updates = {};
                    updates[`users/${state.player1.id}/status`] = 'idle';
                    updates[`users/${state.player1.id}/currentGameId`] = null;
                    updates[`users/${state.player2.id}/status`] = 'idle';
                    updates[`users/${state.player2.id}/currentGameId`] = null;
                    updates[`games/${currentGameId}`] = null;
                    ref(db).update(updates);
                }
             });
             cleanUpAfterGame();
        });

        function cleanUpAfterGame() {
            set(ref(db, `users/${userId}/status`), 'idle');
            remove(ref(db, `users/${userId}/currentGameId`));
            
            currentGameId = null;
            if (gameListener) {
                gameListener(); 
                gameListener = null;
            }
            
            optionAButton.classList.remove('hidden');
            optionBButton.classList.remove('hidden');
            endGameButton.classList.add('hidden');

            setupLobby(ref(db, `users/${userId}`));
        }
    </script>
</body>
</html>



